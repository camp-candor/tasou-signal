---
// src/components/CensusSepulcher.astro
const characters = [
  // This data would be fetched from your content files
  {
    name: 'Silas Blackwood',
    status: 'given',
    epitaph: '"The swamp... it remembers."',
    portrait: 'silas',
    audio: 'whisper-1',
  },
  {
    name: 'Eleanor Vance',
    status: 'wandering',
    epitaph: '"I will find what he lost."',
    portrait: 'eleanor',
    audio: 'whisper-2',
  },
  {
    name: 'Brother Micah',
    status: 'sheltered',
    epitaph: '"Salvation is a flickering light."',
    portrait: 'micah',
    audio: 'whisper-3',
  },
];
---

<section id="census" class="content-section">
  <h2 class="sepulcher-heading">The Census of the Lost</h2>
  <div class="sepulcher-wall">
    <div class="scroll-fader left"></div>
    <div class="sepulcher-corridor">
      {
        characters.map((char) => (
          <div
            class="sepulcher-niche"
            data-status={char.status}
            data-audio={`/sounds/${char.audio}.mp3`}
            data-epitaph={char.epitaph}
          >
            <div class="death-mask-container">
              <img
                src={`/images/masks/${char.portrait}-${char.status}.png`}
                alt={`Death mask of ${char.name}`}
                class="death-mask"
              />
              <div class="mask-glow" />
            </div>
            <div class="candle-container">
              <img
                src={`/images/candle-${char.status === 'given' ? 'broken' : 'whole'}.png`}
                alt="Votive candle"
                class="candle"
              />
              <div class="ember-glow" />
            </div>
            <div class="nameplate">
              <span class="character-name">{char.name}</span>
              <span class="epitaph-text" />
            </div>
          </div>
        ))
      }
    </div>
    <div class="scroll-fader right"></div>
  </div>
</section>

<style>
  .content-section {
    padding: 4rem 0;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .sepulcher-heading {
    font-family: 'UnifrakturMaguntia', cursive;
    font-size: 2.5rem;
    color: #4a3f35;
    text-align: center;
    margin-bottom: 2rem;
    text-shadow:
      1px 1px 0px rgba(255, 255, 255, 0.1),
      -1px -1px 0px rgba(0, 0, 0, 0.5);
  }

  .sepulcher-wall {
    position: relative;
    width: 100%;
    padding: 2rem 0;
    background-image: url('/textures/wet-stone-wall.jpg');
    box-shadow: inset 0 0 50px #000;
    overflow: hidden;
  }

  .sepulcher-corridor {
    display: flex;
    width: max-content;
    padding: 0 5vw;
    transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .scroll-fader {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 15%;
    max-width: 200px;
    z-index: 10;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.5s;
  }

  .scroll-fader.left {
    left: 0;
    background: linear-gradient(to right, rgba(0, 0, 0, 0.8) 0%, transparent 100%);
  }

  .scroll-fader.right {
    right: 0;
    background: linear-gradient(to left, rgba(0, 0, 0, 0.8) 0%, transparent 100%);
  }

  .scroll-fader.is-active {
    pointer-events: auto;
    opacity: 1;
  }

  .sepulcher-niche {
    position: relative;
    flex: 0 0 250px;
    height: 400px;
    margin: 0 1.5rem;
    background-image: url('/images/stone-niche.png');
    background-size: 100% 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background-image:
      radial-gradient(
        circle 200px at var(--wisp-x, -999px) var(--wisp-y, -999px),
        rgba(255, 220, 180, 0.1) 0%,
        transparent 70%
      ),
      url('/images/stone-niche.png');
  }

  .death-mask-container {
    position: relative;
  }

  .death-mask {
    width: 150px;
    filter: drop-shadow(0 4px 10px #000);
  }

  .mask-glow {
    position: absolute;
    inset: 0;
    background: radial-gradient(circle, #fff 0%, transparent 70%);
    opacity: 0;
    transition: opacity 0.5s;
  }

  .sepulcher-niche.is-active .mask-glow {
    opacity: 0.1;
    animation: pulse 3s infinite;
  }

  .candle-container {
    position: relative;
    margin-top: 1rem;
  }

  .ember-glow {
    position: absolute;
    top: -5px;
    left: 50%;
    transform: translateX(-50%);
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #ffab40;
    box-shadow: 0 0 10px 5px #ffab40;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .sepulcher-niche:hover .ember-glow {
    opacity: 1;
  }

  .nameplate {
    margin-top: 1rem;
    text-align: center;
  }

  .character-name {
    font-family: 'Special Elite', monospace;
    color: #a09080;
    transition: opacity 0.3s;
  }

  .sepulcher-niche:hover .character-name {
    opacity: 0;
  }

  .epitaph-text {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    font-family: 'IM Fell English', serif;
    font-style: italic;
    color: #fff;
    opacity: 0;
    transition: opacity 0.5s 0.3s;
    text-shadow: 0 0 10px #fff;
  }

  .sepulcher-niche.is-active .epitaph-text {
    opacity: 1;
  }
</style>
<script>
  const wall = document.querySelector('.sepulcher-wall') as HTMLElement | null;
  const corridor = document.querySelector('.sepulcher-corridor') as HTMLElement | null;
  const niches = document.querySelectorAll('.sepulcher-niche');
  const faderLeft = document.querySelector('.scroll-fader.left') as HTMLElement | null;
  const faderRight = document.querySelector('.scroll-fader.right') as HTMLElement | null;

  const ambience = new Audio('/sounds/sepulcher-ambience.mp3');
  ambience.loop = true;
  ambience.volume = 0;
  const emberSound = new Audio('/sounds/ember-glow.mp3');
  const activateSound = new Audio('/sounds/mask-activate.mp3');

  let hasInteracted = false;
  let activeWhisper: HTMLAudioElement | null = null;
  let scrollInterval: ReturnType<typeof setInterval> | null = null;

  function startAmbience() {
    if (!hasInteracted && ambience) {
      ambience.play();
      ambience.animate({ volume: 0.3 }, { duration: 2000, fill: 'forwards' });
      hasInteracted = true;
    }
  }

  function checkScrollState() {
    if (corridor && wall && faderLeft && faderRight) {
      const isScrollable = corridor.scrollWidth > wall.clientWidth;
      if (!isScrollable) return;
      faderLeft.classList.toggle('is-active', corridor.scrollLeft > 0);
      faderRight.classList.toggle('is-active', corridor.scrollLeft < corridor.scrollWidth - wall.clientWidth - 1);
    }
  }

  function initializeSepulcher() {
    if (wall) {
      wall.addEventListener('mousemove', (e: MouseEvent) => {
        niches.forEach((niche) => {
          const nicheEl = niche as HTMLElement;
          const nicheRect = nicheEl.getBoundingClientRect();
          nicheEl.style.setProperty('--wisp-x', `${e.clientX - nicheRect.left}px`);
          nicheEl.style.setProperty('--wisp-y', `${e.clientY - nicheRect.top}px`);
        });
      });
    }

    niches.forEach((niche) => {
      const nicheEl = niche as HTMLElement;
      nicheEl.addEventListener('mouseenter', () => {
        startAmbience();
        if (nicheEl.dataset.status !== 'sheltered') {
          emberSound.currentTime = 0;
          emberSound.volume = 0.5;
          emberSound.play();
        }
      });
      nicheEl.addEventListener('click', () => {
        if (nicheEl.classList.contains('is-active')) return;
        niches.forEach((n) => n.classList.remove('is-active'));
        if (activeWhisper) {
          activeWhisper.pause();
        }
        nicheEl.classList.add('is-active');
        activateSound.currentTime = 0;
        activateSound.play();
        const audioSrc = nicheEl.dataset.audio;
        if (audioSrc) {
          activeWhisper = new Audio(audioSrc);
          if (activeWhisper) {
            activeWhisper.volume = 0.8;
            activeWhisper.play();
          }
        }
        const epitaphEl = nicheEl.querySelector('.epitaph-text');
        if (epitaphEl) {
          epitaphEl.textContent = nicheEl.dataset.epitaph || '';
        }
        setTimeout(() => {
          nicheEl.classList.remove('is-active');
          if (epitaphEl) {
            epitaphEl.textContent = '';
          }
        }, 5000);
      });
    });

    const startScrolling = (direction: number) => {
      if (scrollInterval) return;
      scrollInterval = setInterval(() => {
        const scrollAmount = direction * 5;
        if (corridor) {
          corridor.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }
      }, 16);
    };

    const stopScrolling = () => {
      if (scrollInterval) {
        clearInterval(scrollInterval);
        scrollInterval = null;
      }
    };

    if (faderLeft && faderRight) {
      faderLeft.addEventListener('mouseenter', () => startScrolling(-1));
      faderLeft.addEventListener('mouseleave', stopScrolling);
      faderRight.addEventListener('mouseenter', () => startScrolling(1));
      faderRight.addEventListener('mouseleave', stopScrolling);
    }

    if (corridor) {
      corridor.addEventListener('scroll', checkScrollState);
    }
    window.addEventListener('resize', checkScrollState);

    checkScrollState();

    if (wall) {
      const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting) {
          wall.addEventListener('click', startAmbience, { once: true });
          observer.disconnect();
        }
      });
      observer.observe(wall);
    }
  }

  initializeSepulcher();
</script>
