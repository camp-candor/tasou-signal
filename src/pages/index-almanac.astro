---
// src/pages/index-almanac.astro
// src/pages/index-almanac.astro
import AlmanacLayout from '../layouts/AlmanacLayout.astro';
import KeyholeIcon from '~/components/KeyholeIcon.astro';
import SurveyMap from '~/components/SurveyMap.astro';
import TestamentsDrawer from '../components/TestamentsDrawer.astro';
import CensusSepulcher from '../components/CensusSepulcher.astro';
import ScryingBowl from '~/components/widgets/ScryingBowl.astro';
import FinalInvitation from '~/components/FinalInvitation.astro';
import '~/assets/styles/almanac-separators.css';
---

<AlmanacLayout>
  <header class="almanac-header">
    <h1>The Blackwood Parish Almanac</h1>
    <p class="living-date">The 217th Day since the River Beckoned.</p>
  </header>
  <nav class="almanac-nav">
    <div class="nav-links">
      <a href="#survey" class="nav-link">The Survey</a>
      <a href="#testaments" class="nav-link">The Testaments</a>
      <a href="#census" class="nav-link">The Census</a>
      <a href="#whispers" class="nav-link">Whispers & Warnings</a>
    </div>
    <div class="auth-link-container">
      <button id="signInButton" class="auth-link">
        <KeyholeIcon />
        <span>Inscribe Your Name</span>
      </button>
    </div>
  </nav>

  <!-- Surveyor's Tools Separator -->
  <div class="surveyors-tools distort">
    <div class="candle-light-overlay"></div>
  </div>

  <section id="survey" class="scroll-section">
    <SurveyMap />
  </section>

  <!-- Ink Blot & Epigraph Separator -->
  <div class="ink-blot-epigraph">
    <p class="epigraph-text">...and so the Parish keeps its own accounts.</p>
  </div>

  <TestamentsDrawer />

  <!-- Stitched Seam Separator -->
  <div class="stitched-seam"></div>

  <CensusSepulcher />

  <!-- Rusted Nameplate Separator for Whispers -->
  <div class="rusted-nameplate">
    <div class="plate-text">Whispers & Warnings</div>
  </div>

  <ScryingBowl />

  <FinalInvitation />
</AlmanacLayout>

<script>
  // Intersection Observer for scroll animations
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
        }
      });
    },
    { rootMargin: '0px 0px -150px 0px' }
  );

  document.querySelectorAll('.scroll-section').forEach((el) => observer.observe(el));

  // Mouse tracking for Ink Blot effect
  const inkBlot = document.querySelector('.ink-blot-epigraph') as HTMLElement;
  if (inkBlot) {
    document.addEventListener('mousemove', (e) => {
      const { clientX, clientY } = e;
      const { left, top } = inkBlot.getBoundingClientRect();
      inkBlot.style.setProperty('--mouse-x', `${clientX - left}px`);
      inkBlot.style.setProperty('--mouse-y', `${clientY - top}px`);
    });
  }

  // Omen Moth interactivity
  document.addEventListener('DOMContentLoaded', () => {
    const moths = document.querySelectorAll('.omen-moth');

    moths.forEach((moth) => {
      moth.addEventListener('click', (event) => {
        event.stopPropagation(); // Prevent click from bubbling up to the document
        const wasActive = moth.classList.contains('is-active');

        // Deactivate all moths
        moths.forEach((otherMoth) => {
          otherMoth.classList.remove('is-active');
        });

        // Activate the clicked moth if it wasn't already active
        if (!wasActive) {
          moth.classList.add('is-active');
        }
      });
    });

    // Click outside to close any active moth
    document.addEventListener('click', () => {
      moths.forEach((moth) => {
        moth.classList.remove('is-active');
      });
    });
  });
</script>

<style>
  .scroll-section {
    opacity: 0;
    transform: translateY(3rem);
    transition:
      opacity 1s ease-out,
      transform 0.8s ease-out;
  }
  .scroll-section.is-visible {
    opacity: 1;
    transform: translateY(0);
  }
  .almanac-content {
    display: grid;
    grid-template-columns: 1fr min(1200px, 90vw) 1fr; /* Center column for content */
  }
  .almanac-content > * {
    grid-column: 2;
  }
  #survey {
    grid-column: 1 / -1; /* Span all columns, from first to last */
    width: 100%;
    position: relative; /* For positioning overlays like the fog */
  }
  .testaments-grid,
  .census-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    padding: 4rem 0;
  }
  .testament-card,
  .census-portrait {
    background: var(--paper-bg); /* Make them look like their own pieces of paper */
    padding: 1.5rem;
    box-shadow: 2px 2px 15px rgba(0, 0, 0, 0.5); /* Lift off the page */
    border: 1px solid rgba(0, 0, 0, 0.2);
  }
  .testament-card:nth-child(5n + 1) {
    transform: rotate(-1.5deg);
  }
  .testament-card:nth-child(5n + 2) {
    transform: rotate(0.8deg);
  }
  .testament-card:nth-child(5n + 3) {
    transform: rotate(2deg);
    margin-top: -1rem;
  }
  .testament-card:nth-child(5n + 4) {
    transform: rotate(-0.5deg);
  }
  .testament-card.is-wide {
    grid-column: span 2; /* This card will take up two columns */
  }
</style>
